# Pruned trained ternary quantization for medical signal classification models

## I) Introduction

GitHub repository for the sumbission of the paper *Trainable pruned ternary quantization for medical signal classification models* for Neurocomputing.

## II) Configuration

To be able to run the different codes (Linux platforms), you need to start by running the following command:

    export PYTHONPATH="${PYTHONPATH}:pathToThe_pTTQ_Code"

Then, you should install the different libraries needed to execute the different codes:

    pip install -r requirements.txt

## III) Proposed method

![image](https://github.com/pTTQSubmission/pTTQ/blob/main/figs/MethodOverview.jpg) 

In a nutshell, our proposed method is composed of three steps, inspired from TTQ ([Zhu et al. (2016)](https://arxiv.org/abs/1612.01064)):
- **Pruning:** pruning is done before ternarization based on the weights's statistics and one weakly-differentiable pruning function with learnable parameters.
- **Ternarization**: the remaining positive weights are set to $1$ and the negatives ones to $-1$.
- **Scaling**: two full-precision scaling trainable parameters are assocaited to the ternary weights tensor, one for the positive weights $W_r$, and one for the negative ones, $W_l$.

## IV) Code structure

This repository is structured using different folders:
- **data**: contains the different datasets (ESR and MNIST) used in the different experiments. At the beginning it empty, but when executing the first experiments, data will be downloaded in this folder.
- **figs**: This fodler contains the different figures used as illustrations in this Git repository.
- **parameters_files**: This folder contains json files with the parameters of different experiments.
- **results**: This folder contains the results of the different experiments. At the beginning it is empty, but when executing different experiments, results folders will be generated and saved here.
- **src**: This folder contains the different source codes. More precisely, it contains the source codes used to perform the different experiments in the paper. 

## V) Examples

All the experiments in the paper can be done executing the source codes in th folder *src/Experiments/*. The generated results will be stored in the folder *results* and can be plotted using different codes in *src/utils/*.

### a. Experiments.

The different experiments of the paper can be launched as follows:
- **Experiment 1**: Use the codes *train_model_base.py*, *experiment_TTQ.py*, and *experiment_pTTQ.py* with the parameters files in *parameters_files/*. 
    -*train_model_base.py*: trains full precision models without quantization. The models generated by this experiment are the one that can then be fed to the quantization experiment's codes. Example (execution from the folder *src/Experiments/*): 
    
                            python train_model_base.py --parameters_file ../../parameters_files/MNIST/mnist_FP.json
                            
    -*experiment_TTQ.py*: trains TTQ quantized models, using a pre-trained FP model. Example (execution from the folder *src/Experiments/*): 
    
                            python experiment_TTQ.py --parameters_file ../../parameters_files/MNIST/mnist_TTQ.json
                            
    -*experiment_pTTQ.pt*: trains pTTQ quantized models, using a pre-trained FP model. Example (execution from the folder *src/Experiments/*): 
    
                            python experiment_pTTQ.py --parameters_file ../../parameters_files/MNIST/mnist_pTTQ.json
                            
- **Experiment 2**: Launch *src/Experiments/experiment_pTTQ.py* with the parameters files having *no_weights_statistics* in their names. Example (execution from the folder *src/Experiments/*): 

                            python experiment_pTTQ.py --parameters_file ../../parameters_files/MNIST/mnist_pruning_ttq_no_weights_statistics.json
                            
- **Experiment 3**: Launch *src/Experiments/experiment_symmetric_pTTQ.py* with the parameters files having *symmetric* in their names. Example (execution from the folder *src/Experiments/*): 

                            python experiment_symmetric_pTTQ.py --parameters_file ../../parameters_files/MNIST/mnist_pruning_ttq_symmetric.json

- **Experiment 4**: Launch *src/Experiments/experiment_global_pTTQ.py* with the parameters files having *granularity* in their names. Example (execution from the folder *src/Experiments/*): 

                            python experiment_global_pTTQ.py --parameters_file ../../parameters_files/MNIST/mnist_pruning_ttq_global_granularity.json
    
### b. Plot results.

The results obtained in the previous experiments before, can be plotted and visualized using different codes in *src/utils/*:
- **plot_results_classification.py**: plots the training and testing curves for the results of an experiment (loss, MCC, and sparsity rates). Example (execution from the folder *src/utils/*):

                            python plot_results_classification.py --results_folder ../../results/ESR_2D_CNN_FP/metrics/ --plot_curves True --plot_sparsity_rate True

- **getCompressionRate.py**: allows to get the compression rates and compression rates of a model with respect to another one. Example (execution from the folder *src/utils/*):

                            python getCompressionRate.py --exp_folder_model_a ../../results/MNIST_2D_CNN_FP/ --is_model_a_ternarized False --exp_folder_model_b ../../results/MNIST_pTTQ/ --is_model_b_ternarized True

- **getEnergyConsumption.py**: computes the energy consumption of a model Model_Q with respect to a reference Model_FP. Example (execution from the folder *src/utils/*):

                            python getEnergyConsumption.py --exp_results_folder_ref PATH/TO/MODEL_FP/ --exp_results_folder PATH/TO/MODEL_Q/
