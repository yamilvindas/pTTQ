# An asymmetric heuristic for trained ternary quantization based on the weights' statistics

## I) Introduction

GitHub repository for the sumbission of the paper *An asymmetric heuristic for trained ternary quantization based on the statistics of the weights: an application to medical signal classification* for Pattern Recognition Letters.

## II) Configuration

To be able to run the different codes (Linux platforms), you need to start by running the following command:

    export PYTHONPATH="${PYTHONPATH}:pathToThe_aTTQ_Code"

Then, you should install the different libraries needed to execute the different codes:

    pip install -r requirements.txt

## III) Proposed method

![image](https://github.com/attq-submission/aTTQ/blob/main/figs/MethodOverview.jpg) 

In a nutshell, our proposed method is composed of three steps, inspired from TTQ ([Zhu et al. (2016)](https://arxiv.org/abs/1612.01064)):
- **Pruning:** pruning is done before ternarization based on the weights's statistics, by introducing two asymmetric parameters controlling the sparsity rate.
- **Ternarization**: the remaining positive weights are set to $1$ and the negatives ones to $-1$.
- **Scaling**: two full-precision scaling trainable parameters are assocaited to the ternary weights tensor, one for the positive weights $W_r$, and one for the negative ones, $W_l$.

## IV) Code structure

This repository is structured using different folders:
- **data**: contains the different datasets (ESR and MNIST) used in the different experiments. At the beginning it empty, but when executing the first experiments, data will be downloaded in this folder.
- **figs**: This fodler contains the different figures used as illustrations in this Git repository.
- **parameters_files**: This folder contains json files with the parameters of different experiments.
- **results**: This folder contains the results of the different experiments. At the beginning it is empty, but when executing different experiments, results folders will be generated and saved here.
- **src**: This folder contains the different source codes. More precisely, it contains the source codes used to perform the different experiments in the paper. 

## V) Examples

All the experiments in the paper can be done executing the source codes in th folder *src/Experiments/*. The generated results will be stored in the folder *results* and can be plotted using different codes in *src/utils/*.

### a. Experiments.

The different experiments of the paper can be launched as follows:
- **Experiment 1**: Use the codes *train_model_base.py*, *experiment_TTQ.py*, and *experiment_aTTQ.py* with the parameters files in *parameters_files/* (except the ones with *GridSearch* in their names. 
    -*train_model_base.py*: trains full precision models without quantization. The models generated by this experiment are the one that can then be fed to the quantization experiment's codes. Example (execution from the folder *src/Experiments/*): 
    
                            python train_model_base.py --parameters_file ../../parameters_files/MNIST/mnist_FP.json
                            
    -*experiment_TTQ.py*: trains TTQ quantized models, using a pre-trained FP model. Example (execution from the folder *src/Experiments/*): 
    
                            python experiment_TTQ.py --parameters_file ../../parameters_files/MNIST/mnist_TTQ.json
                            
    -*experiment_aTTQ.pt*: trains aTTQ quantized models, using a pre-trained FP model. Example (execution from the folder *src/Experiments/*): 
    
                            python experiment_aTTQ.py --parameters_file ../../parameters_files/MNIST/mnist_aTTQ.json
                            
- **Experiment 2**: Launch *src/Experiments/experiment_aTTQ.py* with the parameters files having *GridSearch* in their names. Example (execution from the folder *src/Experiments/*): 

                            python experiment_aTTQ.py --parameters_file ../../parameters_files/MNIST/mnist_aTTQ_GridSearch.json
                            
- **Experiment 3**: Launch the sames codes as in Experiment 1, but using only the aTTQ parameters files, and changing the *"do_normalization_weights": false* to *"do_normalization_weights": true,* in the .json parameters files.
    
### b. Plot results.

The results obtained in the previous experiments before, can be plotted and visualized using different codes in *src/utils/*:
- **plot_results_classification.py**: plots the training and testing curves for the results of an experiment (loss, MCC, and sparsity rates). Example (execution from the folder *src/utils/*):

                            python plot_results_classification.py --results_folder ../../results/ESR_2D_CNN_FP/metrics/ --plot_curves True --plot_sparsity_rate True

- **getCompressionRate.py**: allows to get the compression rates and compression rates of a model with respect to another one. Example (execution from the folder *src/utils/*):

                            python getCompressionRate.py --exp_folder_model_a ../../results/MNIST_2D_CNN_FP/ --is_model_a_ternarized False --exp_folder_model_b ../../results/MNIST_aTTQ/ --is_model_b_ternarized True

- **generateMatrixATTQ.py**: allows to generate two matrices contaiing the sparsity rates and classification performances of the results of experiment 2. Example (execution from the folder *src/utils/*):

                            python generateMatrixATTQ.py --exp_results_folder ../../results/MNIST_aTTQ_GridSearch/

